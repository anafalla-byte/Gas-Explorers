<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Explorers</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Lucide Icons (standard script load) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom range slider styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.4);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="range"]:hover::-moz-range-thumb {
            background: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.4);
        }
        input[type="range"]::-ms-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="range"]:hover::-ms-thumb {
            background: #6366f1;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.4);
        }

        @keyframes fade-in-down {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .animate-fade-in-down {
            animation: fade-in-down 1s ease-out forwards;
        }

        .animate-fade-in {
            animation: fade-in 1.5s ease-out forwards;
        }
        .lucide {
            display: inline-block; /* Ensure icons behave well with text */
            vertical-align: middle; /* Align icons vertically with text */
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-50">
    <div id="app-root"></div>

    <script>
        // Placeholder for your Google Apps Script Web App URL
        // IMPORTANT: Replace this with your actual deployed Apps Script URL
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwf-Buah7nrsvHgOz2DQ5-Dlt5mp3V8VFhb8KGB_ndxLbmk65eDnEUiRwk0bLyjD7xfyA/exec';

        const translations = {
            es: {
                appTitle: "Gas Explorers",
                home: "Inicio",
                virtualLab: "Laboratorio Virtual üî¨",
                theoryZone: "Zona de Teor√≠a üìö",
                challenges: "Desaf√≠os Gas√≠sticos üéØ",
                selectLanguage: "Selecciona el idioma",
                boyleLaw: "Ley de Boyle (Temperatura constante)",
                charlesLaw: "Ley de Charles (Presi√≥n constante)",
                gayLussacLaw: "Ley de Gay-Lussac (Volumen constante)",
                generalGasLaw: "Ley General de los Gases (Todas las variables libres)",
                selectLaw: "Selecciona una Ley:",
                pressure: "Presi√≥n (P)",
                volume: "Volumen (V)",
                temperature: "Temperatura (T)",
                particles: "Part√≠culas",
                setVolume: "Ajustar Volumen",
                setTemperature: "Ajustar Temperatura",
                p_v_graph: "Gr√°fica P vs. V",
                v_t_graph: "Gr√°fica V vs. T",
                p_t_graph: "Gr√°fica P vs. T",
                theoreticalExplanation: "Explicaci√≥n Sencilla",
                formula: "F√≥rmula Clara",
                everydayExamples: "Ejemplos Cotidianos",
                historicalContext: "Contexto Hist√≥rico",
                advancedApplications: "Aplicaciones Avanzadas",

                boyle_theory_title: "Ley de Boyle",
                boyle_theory_explanation: "La Ley de Boyle establece una relaci√≥n inversamente proporcional entre la presi√≥n y el volumen de un gas ideal cuando la temperatura y la cantidad de gas se mantienen constantes. Esto significa que si aumentas el volumen de un gas, su presi√≥n disminuir√°, y viceversa. Es una ley fundamental en la termodin√°mica y la f√≠sica de gases.",
                boyle_theory_formula: "$$P_1V_1 = P_2V_2$$",
                boyle_theory_examples: "Un buceador que asciende a la superficie: a medida que sube, la presi√≥n externa disminuye, y el volumen de gas en sus pulmones aumenta si no exhala, lo que puede ser peligroso si no se exhala correctamente. Tambi√©n, al presionar el √©mbolo de una jeringa llena de aire con la salida bloqueada, el volumen disminuye y la presi√≥n interna aumenta.",
                boyle_theory_historical: "Robert Boyle formul√≥ esta ley en 1662. Realiz√≥ experimentos con un tubo en forma de J, a√±adiendo mercurio para cambiar la presi√≥n y observando c√≥mo variaba el volumen del aire atrapado. Sus hallazgos fueron cruciales para el desarrollo de la qu√≠mica y la f√≠sica modernas.",
                boyle_theory_advanced: "En la industria, la Ley de Boyle se aplica en el dise√±o de compresores y motores de combusti√≥n. En medicina, es relevante en la anestesiolog√≠a y el funcionamiento de respiradores. Tambi√©n es fundamental para entender el comportamiento de los gases a alta presi√≥n, como en tanques de buceo o extintores.",

                charles_theory_title: "Ley de Charles",
                charles_theory_explanation: "La Ley de Charles describe la relaci√≥n directa entre el volumen y la temperatura absoluta de un gas ideal a presi√≥n y cantidad de gas constantes. Si la temperatura de un gas aumenta, sus part√≠culas se mueven m√°s r√°pido y chocan con m√°s fuerza, lo que, para mantener la presi√≥n constante, requiere que el volumen del recipiente aumente. Inversamente, al enfriar un gas, su volumen disminuye.",
                charles_theory_formula: "$$\\frac{V_1}{T_1} = \\frac{V_2}{T_2}$$",
                charles_theory_examples: "Un globo aerost√°tico: el aire dentro del globo se calienta, su volumen aumenta y se vuelve menos denso que el aire exterior, lo que permite que el globo ascienda. Una botella de pl√°stico vac√≠a que se deforma en el refrigerador: al enfriarse el aire dentro, su volumen disminuye y la botella se contrae ligeramente.",
                charles_theory_historical: "Jacques Charles realiz√≥ experimentos a finales del siglo XVIII, observando c√≥mo el volumen de un gas se expand√≠a o contra√≠a linealmente con la temperatura. Aunque √©l no public√≥ sus hallazgos de inmediato, John Dalton y Joseph Louis Gay-Lussac confirmaron y publicaron la ley m√°s tarde, atribuyendo el descubrimiento a Charles.",
                charles_theory_advanced: "Esta ley es crucial en la ingenier√≠a de motores t√©rmicos y refrigeraci√≥n. Es la base para comprender c√≥mo funcionan los term√≥metros de gas y c√≥mo la altitud afecta el rendimiento de los motores debido a los cambios de temperatura y, por ende, de volumen del aire.",

                gayLussac_theory_title: "Ley de Gay-Lussac",
                gayLussac_theory_explanation: "La Ley de Gay-Lussac establece que la presi√≥n de un gas ideal es directamente proporcional a su temperatura absoluta, siempre y cuando el volumen y la cantidad de gas se mantengan constantes. Al aumentar la temperatura, las part√≠culas de gas ganan energ√≠a cin√©tica, chocan con mayor frecuencia y fuerza contra las paredes del recipiente, lo que resulta en un aumento de la presi√≥n.",
                gayLussac_theory_formula: "$$\\frac{P_1}{T_1} = \\frac{P_2}{T_2}$$",
                gayLussac_theory_examples: "Una olla a presi√≥n: el agua hierve a una temperatura m√°s alta debido al aumento de presi√≥n dentro de la olla, lo que cocina los alimentos m√°s r√°pido. El peligro de dejar un spray cerca del fuego: el calor aumenta dr√°sticamente la presi√≥n interna del gas en el recipiente, pudiendo provocar una explosi√≥n.",
                gayLussac_theory_historical: "Joseph Louis Gay-Lussac public√≥ esta ley en 1802. Sus experimentos demostraron que, para una masa fija de gas y un volumen constante, la presi√≥n ejercida por el gas era directamente proporcional a su temperatura absoluta. Esta ley complement√≥ los trabajos de Boyle y Charles.",
                gayLussac_theory_advanced: "La Ley de Gay-Lussac es fundamental en el dise√±o de sistemas de seguridad para contenedores a presi√≥n, como calderas y tanques de almacenamiento de gases. Tambi√©n se aplica en la calibraci√≥n de man√≥metros y en la comprensi√≥n de c√≥mo los cambios de temperatura afectan la presi√≥n en sistemas cerrados como el circuito de un refrigerador.",

                general_theory_title: "Ley General de los Gases",
                general_theory_explanation: "La Ley General de los Gases es una combinaci√≥n de las leyes de Boyle, Charles y Gay-Lussac. Describe la relaci√≥n entre la presi√≥n, el volumen y la temperatura absoluta de una cantidad fija de gas. Es una herramienta poderosa para predecir el comportamiento de un gas cuando dos o m√°s de sus propiedades cambian simult√°neamente.",
                general_theory_formula: "$$\\frac{P_1V_1}{T_1} = \\frac{P_2V_2}{T_2}$$",
                general_theory_examples: "Neum√°ticos de un coche: la presi√≥n, el volumen y la temperatura de los neum√°ticos var√≠an con la conducci√≥n y las condiciones ambientales. En un d√≠a caluroso, la temperatura del aire en el neum√°tico sube, lo que aumenta la presi√≥n y ligeramente el volumen. En un motor de combusti√≥n interna, los gases experimentan cambios r√°pidos en P, V y T durante cada ciclo.",
                general_theory_historical: "Aunque no hay un √∫nico descubridor para la Ley General, es el resultado de la integraci√≥n del trabajo de Boyle, Charles y Gay-Lussac. Representa un entendimiento m√°s completo del comportamiento macrosc√≥pico de los gases ideales.",
                general_theory_advanced: "Esta ley es omnipresente en la ingenier√≠a qu√≠mica, la meteorolog√≠a y la astron√°utica. Se utiliza para modelar la atm√≥sfera terrestre, dise√±ar sistemas de soporte vital en el espacio, y optimizar procesos industriales que involucran gases a diferentes condiciones.",

                quizIntro: "Responde estas preguntas para poner a prueba tus conocimientos sobre las leyes de los gases.",
                correct: "¬°Correcto!",
                incorrect: "Incorrecto. La respuesta correcta era: ",
                submitAnswer: "Enviar Respuesta",
                nextQuestion: "Siguiente Pregunta",
                registerForQuiz: "Registrarse para la Evaluaci√≥n",
                studentName: "Nombre del Estudiante:",
                studentCourse: "Curso:",
                startButton: "Comenzar Evaluaci√≥n",
                saveResults: "Guardar Resultados",
                savingResults: "Guardando resultados...",
                resultsSaved: "Resultados guardados correctamente.",
                saveError: "Error al guardar resultados:",
                enterNameCourse: "Por favor, ingresa tu nombre y curso para comenzar la evaluaci√≥n.",
                evaluationAlreadyCompleted: "Ya has completado esta evaluaci√≥n. No se permiten m√∫ltiples intentos.",
                duplicateTemporary: "Env√≠o duplicado detectado recientemente. Espera unos minutos antes de intentar de nuevo.",
                questions: [
                    {
                        question: "¬øQu√© ley establece que la presi√≥n y el volumen de un gas son inversamente proporcionales a temperatura constante?",
                        options: ["Ley de Charles", "Ley de Boyle", "Ley de Gay-Lussac", "Ley General"],
                        answer: "Ley de Boyle"
                    },
                    {
                        question: "Si la temperatura de un gas aumenta mientras la presi√≥n se mantiene constante, ¬øqu√© sucede con su volumen?",
                        options: ["Disminuye", "Aumenta", "Permanece igual", "Es impredecible"],
                        answer: "Aumenta"
                    },
                    {
                        question: "En un experimento, mantienes el volumen de un gas constante. Si duplicas su temperatura absoluta, ¬øqu√© le sucede a su presi√≥n?",
                        options: ["Se reduce a la mitad", "Se duplica", "Permanece igual", "Aumenta al cu√°druple"],
                        answer: "Se duplica"
                    },
                    {
                        question: "¬øQu√© ley describe la relaci√≥n directa entre la presi√≥n y la temperatura de un gas a volumen constante?",
                        options: ["Ley de Charles", "Ley de Boyle", "Ley de Gay-Lussac", "Ley General"],
                        answer: "Ley de Gay-Lussac"
                    },
                    {
                        question: "Seg√∫n la Ley de Charles, si reduces la temperatura de un gas a la mitad (en Kelvin) manteniendo la presi√≥n constante, ¬øqu√© le ocurre al volumen?",
                        options: ["Se reduce a la mitad", "Se duplica", "Permanece igual", "Aumenta al cu√°druple"],
                        answer: "Se reduce a la mitad"
                    },
                    {
                        question: "Un buceador asciende r√°pidamente a la superficie. ¬øQu√© ley explica el aumento del volumen de aire en sus pulmones?",
                        options: ["Ley de Charles", "Ley de Boyle", "Ley de Gay-Lussac", "Ley de Avogadro"],
                        answer: "Ley de Boyle"
                    },
                    {
                        question: "Si un recipiente cerrado con un gas se calienta, y su volumen no puede cambiar, ¬øqu√© ocurre con la presi√≥n interna?",
                        options: ["Disminuye", "Aumenta", "Permanece igual", "Depende del tipo de gas"],
                        answer: "Aumenta"
                    },
                    {
                        question: "¬øCu√°l de las siguientes es la f√≥rmula de la Ley General de los Gases?",
                        options: ["P‚ÇÅV‚ÇÅ = P‚ÇÇV‚ÇÇ", "V‚ÇÅ/T‚ÇÅ = V‚ÇÇ/T‚ÇÇ", "P‚ÇÅ/T‚ÇÅ = P‚ÇÇ/T‚ÇÇ", "(P‚ÇÅV‚ÇÅ)/T‚ÇÅ = (P‚ÇÇV‚ÇÇ)/T‚ÇÇ"],
                        answer: "(P‚ÇÅV‚ÇÅ)/T‚ÇÅ = (P‚ÇÇV‚ÇÇ)/T‚ÇÇ"
                    },
                    {
                        question: "En un experimento, mantienes el volumen de un gas constante. Si duplicas su temperatura absoluta, ¬øqu√© le sucede a su presi√≥n?",
                        options: ["Se reduce a la mitad", "Se duplica", "Permanece igual", "Aumenta al cu√°druple"],
                        answer: "Se duplica"
                    },
                    {
                        question: "Un globo se infla en una habitaci√≥n fr√≠a y luego se lleva a una habitaci√≥n c√°lida. ¬øQu√© ley de los gases predice que el globo se expandir√°?",
                        options: ["Ley de Boyle", "Ley de Charles", "Ley de Gay-Lussac", "Ley de Dalton"],
                        answer: "Ley de Charles"
                    }
                ],
                challengeTitle: "Cuestionario de Conceptos",
                finalScore: (score, total) => `¬°Cuestionario completado! Tu puntuaci√≥n final: ${score} de ${total}`,
            },
        };

        // Current state of the application
        let currentPage = 'home';
        let lang = 'es';
        let virtualLabState = {
            containerWidth: 400,
            containerHeight: 300, // Initial height, changes with volume
            temperature: 273.15, // Kelvin (0-500K for slider)
            pressure: 1, // kPa
            volume: 50, // Percentage of max volume, affects height
            selectedLaw: 'general',
            particles: [],
            numParticles: 30,
            pvData: [],
            vtData: [],
            ptData: [],
            animationFrameId: null
        };
        let theoryZoneState = {
            selectedLaw: 'boyle'
        };
        let challengesZoneState = {
            studentName: '',
            studentCourse: '',
            isRegistered: false,
            currentQuestionIndex: 0,
            selectedOption: null,
            feedback: null,
            score: 0,
            quizCompleted: false,
            saveStatus: '' // '', 'saving', 'saved', 'error', 'evaluation_already_completed', 'duplicate_temporary'
        };

        // Function to render LaTeX content using MathJax
        const renderLatex = (text) => {
            // MathJax will process this text in the DOM after insertion
            return text;
        };

        // Function to get Lucide icons HTML
        function getLucideIcon(iconName, size, className) {
            // Returns the HTML tag that Lucide will convert into an SVG icon
            return `<i data-lucide="${iconName}" class="${className}" style="width:${size}px; height:${size}px;"></i>`;
        }

        // --- Particle Simulation Logic ---
        const initParticles = () => {
            const newParticles = [];
            for (let i = 0; i < virtualLabState.numParticles; i++) {
                newParticles.push({
                    id: i,
                    x: Math.random() * virtualLabState.containerWidth,
                    y: Math.random() * virtualLabState.containerHeight,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                });
            }
            virtualLabState.particles = newParticles;
        };

        const updatePressure = () => {
            let collisionCount = 0;
            const wallCollisionFactor = 0.1;
            virtualLabState.particles.forEach(p => {
                // Adjust for dynamic container size
                if (p.x <= 0 || p.x >= virtualLabState.containerWidth) collisionCount++;
                if (p.y <= 0 || p.y >= virtualLabState.containerHeight) collisionCount++;
            });

            // Simplified pressure calculation: more collisions, higher pressure
            // Also, higher temperature (faster particles) should lead to higher pressure
            const newPressure = (collisionCount * wallCollisionFactor + virtualLabState.numParticles * (virtualLabState.temperature / 500)) / (virtualLabState.volume / 100);
            virtualLabState.pressure = newPressure;
        };

        // Function to directly update the DOM elements in Virtual Lab for performance
        const updateVirtualLabContentDOM = () => {
            const svgContainer = document.querySelector('#gas-container-svg');
            if (svgContainer) {
                // Update particle positions
                svgContainer.innerHTML = virtualLabState.particles.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="rgba(99, 102, 241, 0.8)" />`).join('');
                const gasContainerDiv = document.querySelector('.gas-container');
                if(gasContainerDiv) {
                    gasContainerDiv.style.height = `${virtualLabState.containerHeight}px`;
                }

                // Update readings
                const pressureDisplay = document.getElementById('pressure-display');
                if(pressureDisplay) pressureDisplay.textContent = `${virtualLabState.pressure.toFixed(2)} kPa`;
                const volumeDisplay = document.getElementById('volume-display');
                if(volumeDisplay) volumeDisplay.textContent = `${virtualLabState.volume.toFixed(0)} %`;
                const temperatureDisplay = document.getElementById('temperature-display');
                if(temperatureDisplay) temperatureDisplay.textContent = `${virtualLabState.temperature.toFixed(2)} K`;

                // Update graph paths (requires finding the specific graph SVG and path)
                const updateGraphPath = (graphId, data, xKey, yKey) => {
                    const graphElement = document.getElementById(graphId);
                    if (!graphElement || data.length < 2) return;

                    const margin = 30;
                    const graphWidth = 300;
                    const graphHeight = 200;

                    const xValues = data.map(d => d[xKey]);
                    const yValues = data.map(d => d[yKey]);

                    const maxX = Math.max(...xValues);
                    const minX = Math.min(...xValues);
                    const maxY = Math.max(...yValues);
                    const minY = Math.min(...yValues);

                    // Handle cases where minX/maxX or minY/maxY are the same (e.g., all data points are identical)
                    const rangeX = maxX - minX === 0 ? 1 : maxX - minX;
                    const rangeY = maxY - minY === 0 ? 1 : maxY - minY;

                    const xScale = (val) => margin + ((val - minX) / rangeX) * (graphWidth - 2 * margin);
                    const yScale = (val) => graphHeight - margin - ((val - minY) / rangeY) * (graphHeight - 2 * margin);


                    const pathData = data.map((d, i) => {
                        const x = xScale(d[xKey]);
                        const y = yScale(d[yKey]);
                        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                    }).join(' ');

                    const pathElement = graphElement.querySelector('path');
                    if (pathElement) {
                        pathElement.setAttribute('d', pathData);
                    }
                };

                updateGraphPath('pv-graph-svg', virtualLabState.pvData, 'v', 'p');
                updateGraphPath('vt-graph-svg', virtualLabState.vtData, 't', 'v');
                updateGraphPath('pt-graph-svg', virtualLabState.ptData, 't', 'p');

                 // Update heat/cold source visibility
                const flameIcon = document.querySelector('.heat-source');
                const snowflakeIcon = document.querySelector('.cold-source');

                if (flameIcon) flameIcon.style.display = virtualLabState.temperature > 350 ? 'block' : 'none';
                if (snowflakeIcon) snowflakeIcon.style.display = virtualLabState.temperature < 200 ? 'block' : 'none';
            }
        };


        const animateParticles = () => {
            const updatedParticles = virtualLabState.particles.map(p => {
                let newVx = p.vx;
                let newVy = p.vy;
                let newX = p.x + newVx * (virtualLabState.temperature / 273.15);
                let newY = p.y + newVy * (virtualLabState.temperature / 273.15);

                // Wall collision detection and bounce
                if (newX <= 0 || newX >= virtualLabState.containerWidth) {
                    newVx *= -1;
                    newX = newX <= 0 ? 0 : virtualLabState.containerWidth;
                }
                if (newY <= 0 || newY >= virtualLabState.containerHeight) {
                    newVy *= -1;
                    newY = newY <= 0 ? 0 : virtualLabState.containerHeight;
                }
                return { ...p, x: newX, y: newY, vx: newVx, vy: newVy };
            });
            virtualLabState.particles = updatedParticles;
            updatePressure();

            const time = Date.now();
            virtualLabState.pvData.push({ time, p: virtualLabState.pressure, v: virtualLabState.volume });
            virtualLabState.vtData.push({ time, v: virtualLabState.volume, t: virtualLabState.temperature });
            virtualLabState.ptData.push({ time, p: virtualLabState.pressure, t: virtualLabState.temperature });

            virtualLabState.pvData = virtualLabState.pvData.slice(-100);
            virtualLabState.vtData = virtualLabState.vtData.slice(-100);
            virtualLabState.ptData = virtualLabState.ptData.slice(-100);

            updateVirtualLabContentDOM(); // Update only the dynamic parts of the DOM
            virtualLabState.animationFrameId = requestAnimationFrame(animateParticles);
        };

        const startSimulation = () => {
            if (virtualLabState.animationFrameId) {
                cancelAnimationFrame(virtualLabState.animationFrameId);
            }
            initParticles();
            virtualLabState.animationFrameId = requestAnimationFrame(animateParticles);
        };

        const stopSimulation = () => {
            if (virtualLabState.animationFrameId) {
                cancelAnimationFrame(virtualLabState.animationFrameId);
                virtualLabState.animationFrameId = null;
            }
        };

        // --- Components as functions returning HTML strings ---

        function Navbar() {
            const t = translations[lang];
            return `
                <nav class="bg-indigo-700 p-4 shadow-lg sticky top-0 z-50 rounded-b-xl">
                    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                        <h1 class="text-3xl font-extrabold text-white">
                            ${t.appTitle}
                        </h1>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-6 items-center">
                            <button
                                onclick="setCurrentPageAndRender('home')"
                                class="text-white text-lg font-medium hover:text-indigo-200 transition duration-300 ${currentPage === 'home' ? 'font-bold underline' : ''}"
                            >
                                ${t.home}
                            </button>
                            <button
                                onclick="setCurrentPageAndRender('virtualLab')"
                                class="text-white text-lg font-medium hover:text-indigo-200 transition duration-300 ${currentPage === 'virtualLab' ? 'font-bold underline' : ''}"
                            >
                                ${t.virtualLab}
                            </button>
                            <button
                                onclick="setCurrentPageAndRender('theoryZone')"
                                class="text-white text-lg font-medium hover:text-indigo-200 transition duration-300 ${currentPage === 'theoryZone' ? 'font-bold underline' : ''}"
                            >
                                ${t.theoryZone}
                            </button>
                            <button
                                onclick="setCurrentPageAndRender('challenges')"
                                class="text-white text-lg font-medium hover:text-indigo-200 transition duration-300 ${currentPage === 'challenges' ? 'font-bold underline' : ''}"
                            >
                                ${t.challenges}
                            </button>
                            <div class="relative inline-block text-white">
                                <select
                                    onchange="setLanguage(event.target.value)"
                                    class="block appearance-none bg-indigo-600 border border-indigo-500 text-white py-2 px-4 pr-8 rounded-lg shadow leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                                >
                                    <option value="es" ${lang === 'es' ? 'selected' : ''}>Espa√±ol</option>
                                    <option value="en" ${lang === 'en' ? 'selected' : ''}>English</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    ${getLucideIcon('ChevronDown', 18, 'lucide lucide-chevron-down')}
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            `;
        }

        function Home() {
            const t = translations[lang];
            return `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] bg-gradient-to-br from-blue-50 to-indigo-100 p-8 text-center rounded-lg shadow-xl m-4">
                    <h2 class="text-6xl font-extrabold text-indigo-800 mb-6 animate-fade-in-down">
                        ${t.appTitle}
                    </h2>
                    <p class="text-2xl text-gray-700 max-w-2xl mb-12 leading-relaxed animate-fade-in">
                        ${lang === 'es'
                            ? "Explora el fascinante mundo de las leyes de los gases con simulaciones interactivas, teor√≠a clara y desaf√≠os emocionantes."
                            : "Explore the fascinating world of gas laws with interactive simulations, clear theory, and exciting challenges."
                        }
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-5xl">
                        <button
                            onclick="setCurrentPageAndRender('virtualLab')"
                            class="flex flex-col items-center p-8 bg-white rounded-2xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-105 border-b-4 border-indigo-500 group"
                        >
                            ${getLucideIcon('FlaskConical', 80, 'text-indigo-600 mb-4 group-hover:text-indigo-800 transition-colors')}
                            <span class="text-xl md:text-2xl font-bold text-gray-800 group-hover:text-indigo-900">${t.virtualLab}</span>
                            <p class="text-gray-500 text-md mt-2">
                                ${lang === 'es' ? "Experimenta con presi√≥n, volumen y temperatura." : "Experiment with pressure, volume, and temperature."}
                            </p>
                        </button>

                        <button
                            onclick="setCurrentPageAndRender('theoryZone')"
                            class="flex flex-col items-center p-8 bg-white rounded-2xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-105 border-b-4 border-teal-500 group"
                        >
                            ${getLucideIcon('BookOpen', 80, 'text-teal-600 mb-4 group-hover:text-teal-800 transition-colors')}
                            <span class="text-xl md:text-2xl font-bold text-gray-800 group-hover:text-teal-900">${t.theoryZone}</span>
                            <p class="text-gray-500 text-md mt-2">
                                ${lang === 'es' ? "Aprende los principios fundamentales de cada ley." : "Learn the fundamental principles of each law."}
                            </p>
                        </button>

                        <button
                            onclick="setCurrentPageAndRender('challenges')"
                            class="flex flex-col items-center p-8 bg-white rounded-2xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-105 border-b-4 border-orange-500 group"
                        >
                            ${getLucideIcon('Target', 80, 'text-orange-600 mb-4 group-hover:text-orange-800 transition-colors')}
                            <span class="text-xl md:text-2xl font-bold text-gray-800 group-hover:text-orange-900">${t.challenges}</span>
                            <p class="text-gray-500 text-md mt-2">
                                ${lang === 'es' ? "Pon a prueba tus conocimientos con ejercicios interactivos." : "Test your knowledge with interactive exercises."}
                            </p>
                        </button>
                    </div>
                </div>
            `;
        }

        function Graph({ data, xKey, yKey, title, xLabel, yLabel, id }) {
            // This function creates the SVG structure for a graph
            if (data.length < 2) return `<div class="text-center text-gray-500">${translations[lang].particles}</div>`;

            const margin = 30;
            const graphWidth = 300;
            const graphHeight = 200;

            const xValues = data.map(d => d[xKey]);
            const yValues = data.map(d => d[yKey]);

            const maxX = Math.max(...xValues);
            const minX = Math.min(...xValues);
            const maxY = Math.max(...yValues);
            const minY = Math.min(...yValues);

            const rangeX = maxX - minX === 0 ? 1 : maxX - minX;
            const rangeY = maxY - minY === 0 ? 1 : maxY - minY;

            const xScale = (val) => margin + ((val - minX) / rangeX) * (graphWidth - 2 * margin);
            const yScale = (val) => graphHeight - margin - ((val - minY) / rangeY) * (graphHeight - 2 * margin);

            const pathData = data.map((d, i) => {
                const x = xScale(d[xKey]);
                const y = yScale(d[yKey]);
                return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ');

            return `
                <svg id="${id}" width="${graphWidth}" height="${graphHeight}" class="bg-white rounded-lg shadow-inner">
                    <!-- Axes -->
                    <line x1="${margin}" y1="${graphHeight - margin}" x2="${graphWidth - margin}" y2="${graphHeight - margin}" stroke="#333" />
                    <line x1="${margin}" y1="${margin}" x2="${margin}" y2="${graphHeight - margin}" stroke="#333" />

                    <!-- Labels -->
                    <text x="${graphWidth / 2}" y="${graphHeight - margin / 4}" text-anchor="middle" font-size="10">${xLabel}</text>
                    <text x="${margin / 4}" y="${graphHeight / 2}" text-anchor="middle" transform="rotate(-90 ${margin / 4} ${graphHeight / 2})" font-size="10">${yLabel}</text>
                    <text x="${graphWidth / 2}" y="${margin / 2}" text-anchor="middle" font-size="12" font-weight="bold">${title}</text>

                    <!-- Path - this path's 'd' attribute will be updated dynamically -->
                    <path d="${pathData}" fill="none" stroke="#6366f1" stroke-width="2" />
                </svg>
            `;
        }


        function VirtualLab() {
            const t = translations[lang];

            // Functions defined internally to ensure they reference `t` and `virtualLabState` correctly
            const handleVolumeChange = (newVolume) => {
                virtualLabState.volume = newVolume;
                virtualLabState.containerHeight = newVolume * 3;

                if (virtualLabState.selectedLaw === 'boyle') {
                    const initialPressure = virtualLabState.pvData.length > 0 ? virtualLabState.pvData[0].p : 1;
                    const initialVolume = virtualLabState.pvData.length > 0 ? virtualLabState.pvData[0].v : 50;
                    if (newVolume !== 0) { // Avoid division by zero
                        virtualLabState.pressure = (initialPressure * initialVolume) / newVolume;
                    }
                } else if (virtualLabState.selectedLaw === 'charles' && virtualLabState.pressure > 0) {
                    const initialVolume = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].v : 50;
                    const initialTemp = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].t : 273.15;
                    if (initialVolume !== 0) { // Avoid division by zero
                        virtualLabState.temperature = (initialTemp * newVolume) / initialVolume;
                    }
                }
                renderApp(); // Full render to update the UI
            };

            const handleTemperatureChange = (newTemperature) => {
                virtualLabState.temperature = newTemperature;

                if (virtualLabState.selectedLaw === 'gayLussac' && virtualLabState.temperature > 0) {
                    const initialPressure = virtualLabState.ptData.length > 0 ? virtualLabState.ptData[0].p : 1;
                    const initialTemp = virtualLabState.ptData.length > 0 ? virtualLabState.ptData[0].t : 273.15;
                    if (initialTemp !== 0) { // Avoid division by zero
                        virtualLabState.pressure = (initialPressure * newTemperature) / initialTemp;
                    }
                } else if (virtualLabState.selectedLaw === 'charles' && virtualLabState.temperature > 0) {
                    const initialVolume = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].v : 50;
                    const initialTemp = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].t : 273.15;
                    if (initialTemp !== 0) { // Avoid division by zero
                        virtualLabState.volume = (initialVolume * newTemperature) / initialTemp;
                        virtualLabState.containerHeight = (virtualLabState.volume * 3);
                    }
                }
                renderApp(); // Full render to update the UI
            };

            const handleLawSelectChange = (newLaw) => {
                virtualLabState.selectedLaw = newLaw;
                virtualLabState.pvData = [];
                virtualLabState.vtData = [];
                virtualLabState.ptData = [];
                initParticles(); // Re-initialize particles when law changes
                renderApp(); // Full render to update UI, controls, etc.
            };


            return `
                <div class="p-6 bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen">
                    <h2 class="text-4xl font-extrabold text-indigo-800 mb-8 text-center">${t.virtualLab}</h2>

                    <div class="mb-8 flex flex-wrap justify-center gap-4">
                        <label for="gas-law-select" class="text-lg font-semibold text-gray-700">${t.selectLaw}</label>
                        <div class="relative">
                            <select
                                id="gas-law-select"
                                class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-gray-800"
                                onchange="handleLawSelectChangeInVirtualLab(event.target.value)"
                            >
                                <option value="general" ${virtualLabState.selectedLaw === 'general' ? 'selected' : ''}>${t.generalGasLaw}</option>
                                <option value="boyle" ${virtualLabState.selectedLaw === 'boyle' ? 'selected' : ''}>${t.boyleLaw}</option>
                                <option value="charles" ${virtualLabState.selectedLaw === 'charles' ? 'selected' : ''}>${t.charlesLaw}</option>
                                <option value="gayLussac" ${virtualLabState.selectedLaw === 'gayLussac' ? 'selected' : ''}>${t.gayLussacLaw}</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                ${getLucideIcon('ChevronDown', 18, 'lucide lucide-chevron-down')}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Simulation Area -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center justify-center space-y-8">
                            <h3 class="text-3xl font-bold text-gray-800 mb-4">Simulaci√≥n Interactivas</h3>

                            <!-- Controls -->
                            <div class="flex flex-col md:flex-row gap-6 w-full justify-around items-center">
                                <!-- Volume Control -->
                                <div class="flex flex-col items-center gap-2">
                                    <label for="volume-slider" class="font-semibold text-gray-700 text-lg flex items-center gap-2">
                                        ${getLucideIcon('Ruler', 20, 'lucide lucide-ruler')} ${t.setVolume}
                                    </label>
                                    <input
                                        type="range"
                                        id="volume-slider"
                                        min="10"
                                        max="100"
                                        value="${virtualLabState.volume}"
                                        oninput="handleVolumeChangeInVirtualLab(parseFloat(this.value))"
                                        ${virtualLabState.selectedLaw === 'gayLussac' ? 'disabled' : ''}
                                        class="w-48 h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    />
                                    <span id="volume-display" class="text-indigo-600 font-bold text-xl">${virtualLabState.volume.toFixed(0)}%</span>
                                </div>

                                <!-- Temperature Control -->
                                <div class="flex flex-col items-center gap-2">
                                    <label for="temperature-slider" class="font-semibold text-gray-700 text-lg flex items-center gap-2">
                                        ${getLucideIcon('Thermometer', 20, 'lucide lucide-thermometer')} ${t.setTemperature}
                                    </label>
                                    <input
                                        type="range"
                                        id="temperature-slider"
                                        min="100"
                                        max="500"
                                        step="1"
                                        value="${virtualLabState.temperature}"
                                        oninput="handleTemperatureChangeInVirtualLab(parseFloat(this.value))"
                                        ${virtualLabState.selectedLaw === 'boyle' ? 'disabled' : ''}
                                        class="w-48 h-2 bg-red-200 rounded-lg appearance-none cursor-pointer range-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                    />
                                    <span id="temperature-display" class="text-red-600 font-bold text-xl">${virtualLabState.temperature.toFixed(2)} K</span>
                                </div>
                            </div>

                            <!-- Gas Container -->
                            <div class="relative bg-gray-100 rounded-xl border-4 border-gray-300 overflow-hidden gas-container" style="width: ${virtualLabState.containerWidth}px; height: ${virtualLabState.containerHeight}px;">
                                <!-- Heat/Cold Source -->
                                <span class="absolute bottom-2 left-1/2 -translate-x-1/2 text-orange-500 animate-pulse heat-source" style="display:${virtualLabState.temperature > 350 ? 'block' : 'none'};">${getLucideIcon('Flame', 40, 'lucide lucide-flame')}</span>
                                <span class="absolute top-2 left-1/2 -translate-x-1/2 text-blue-400 animate-pulse cold-source" style="display:${virtualLabState.temperature < 200 ? 'block' : 'none'};">${getLucideIcon('Snowflake', 40, 'lucide lucide-snowflake')}</span>

                                <svg id="gas-container-svg" width="${virtualLabState.containerWidth}" height="${virtualLabState.containerHeight}">
                                    ${virtualLabState.particles.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="rgba(99, 102, 241, 0.8)" />`).join('')}
                                </svg>
                            </div>

                            <!-- Readings -->
                            <div class="flex justify-around w-full mt-4 text-center">
                                <div class="bg-indigo-100 p-4 rounded-xl shadow-md">
                                    <p class="text-lg font-bold text-indigo-700 flex items-center gap-2 justify-center">
                                        ${getLucideIcon('Gauge', 20, 'lucide lucide-gauge')} ${t.pressure}:
                                    </p>
                                    <p id="pressure-display" class="text-3xl font-extrabold text-indigo-900">${virtualLabState.pressure.toFixed(2)} kPa</p>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-xl shadow-md">
                                    <p class="text-lg font-bold text-purple-700 flex items-center gap-2 justify-center">
                                        ${getLucideIcon('Ruler', 20, 'lucide lucide-ruler')} ${t.volume}:
                                    </p>
                                    <p class="text-3xl font-extrabold text-purple-900">${virtualLabState.volume.toFixed(0)} %</p>
                                </div>
                                <div class="bg-red-100 p-4 rounded-xl shadow-md">
                                    <p class="text-lg font-bold text-red-700 flex items-center gap-2 justify-center">
                                        ${getLucideIcon('Thermometer', 20, 'lucide lucide-thermometer')} ${t.temperature}:
                                    </p>
                                    <p class="text-3xl font-extrabold text-red-900">${virtualLabState.temperature.toFixed(2)} K</p>
                                </div>
                            </div>
                        </div>

                        <!-- Graphs Area -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center space-y-6">
                            <h3 class="text-3xl font-bold text-gray-800 mb-4">Gr√°ficas en Tiempo Real</h3>
                            ${Graph({ data: virtualLabState.pvData, xKey: 'v', yKey: 'p', title: t.p_v_graph, xLabel: t.volume, yLabel: t.pressure, id: 'pv-graph-svg' })}
                            ${Graph({ data: virtualLabState.vtData, xKey: 't', yKey: 'v', title: t.v_t_graph, xLabel: t.temperature, yLabel: t.volume, id: 'vt-graph-svg' })}
                            ${Graph({ data: virtualLabState.ptData, xKey: 't', yKey: 'p', title: t.p_t_graph, xLabel: t.temperature, yLabel: t.pressure, id: 'pt-graph-svg' })}
                        </div>
                    </div>
                </div>
            `;
        }

        function TheoryZone() {
            const t = translations[lang];
            const lawContent = {
                boyle: {
                    title: t.boyle_theory_title,
                    explanation: t.boyle_theory_explanation,
                    formula: t.boyle_theory_formula,
                    examples: t.boyle_theory_examples,
                    historical: t.boyle_theory_historical,
                    advanced: t.boyle_theory_advanced,
                },
                charles: {
                    title: t.charles_theory_title,
                    explanation: t.charles_theory_explanation,
                    formula: t.charles_theory_formula,
                    examples: t.charles_theory_examples,
                    historical: t.charles_theory_historical,
                    advanced: t.charles_theory_advanced,
                },
                gayLussac: {
                    title: t.gayLussac_theory_title,
                    explanation: t.gayLussac_theory_explanation,
                    formula: t.gayLussac_theory_formula,
                    examples: t.gayLussac_theory_examples,
                    historical: t.gayLussac_theory_historical,
                    advanced: t.gayLussac_theory_advanced,
                },
                general: {
                    title: t.general_theory_title,
                    explanation: t.general_theory_explanation,
                    formula: t.general_theory_formula,
                    examples: t.general_theory_examples,
                    historical: t.general_theory_historical,
                    advanced: t.general_theory_advanced,
                }
            };

            const currentLawContent = lawContent[theoryZoneState.selectedLaw];

            return `
                <div class="p-6 bg-gradient-to-br from-teal-50 to-cyan-100 min-h-screen">
                    <h2 class="text-4xl font-extrabold text-teal-800 mb-8 text-center">${t.theoryZone}</h2>

                    <div class="mb-8 flex flex-wrap justify-center gap-4">
                        <label for="theory-law-select" class="text-lg font-semibold text-gray-700">${t.selectLaw}</label>
                        <div class="relative">
                            <select
                                id="theory-law-select"
                                class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-gray-800"
                                onchange="handleLawSelectChangeInTheoryZone(event.target.value)"
                            >
                                <option value="boyle" ${theoryZoneState.selectedLaw === 'boyle' ? 'selected' : ''}>${t.boyleLaw}</option>
                                <option value="charles" ${theoryZoneState.selectedLaw === 'charles' ? 'selected' : ''}>${t.charlesLaw}</option>
                                <option value="gayLussac" ${theoryZoneState.selectedLaw === 'gayLussac' ? 'selected' : ''}>${t.gayLussacLaw}</option>
                                <option value="general" ${theoryZoneState.selectedLaw === 'general' ? 'selected' : ''}>${t.generalGasLaw}</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                ${getLucideIcon('ChevronDown', 18, 'lucide lucide-chevron-down')}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-4xl mx-auto space-y-8">
                        <h3 class="text-3xl font-bold text-teal-800 border-b-2 border-teal-200 pb-4">${currentLawContent.title}</h3>

                        <div>
                            <h4 class="text-2xl font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                ${getLucideIcon('BookOpen', 24, 'lucide lucide-book-open')} ${t.theoreticalExplanation}
                            </h4>
                            <p class="text-lg text-gray-600 leading-relaxed">${currentLawContent.explanation}</p>
                        </div>

                        <div>
                            <h4 class="text-2xl font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                ${getLucideIcon('MessageCircleMore', 24, 'lucide lucide-message-circle-more')} ${t.formula}
                            </h4>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-x-auto">
                                <p class="text-xl font-mono text-gray-800">${renderLatex(currentLawContent.formula)}</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-2xl font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                ${getLucideIcon('Target', 24, 'lucide lucide-target')} ${t.everydayExamples}
                            </h4>
                            <ul class="list-disc list-inside text-lg text-gray-600 space-y-2">
                                <li>${currentLawContent.examples}</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="text-2xl font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                ${getLucideIcon('BookOpen', 24, 'lucide lucide-book-open')} ${t.historicalContext}
                            </h4>
                            <p class="text-lg text-gray-600 leading-relaxed">${currentLawContent.historical}</p>
                        </div>

                        <div>
                            <h4 class="text-2xl font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                ${getLucideIcon('FlaskConical', 24, 'lucide lucide-flask-conical')} ${t.advancedApplications}
                            </h4>
                            <p class="text-lg text-gray-600 leading-relaxed">${currentLawContent.advanced}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveResultsToSheets() {
            const t = translations[lang];
            if (!challengesZoneState.studentName || !challengesZoneState.studentCourse) {
                challengesZoneState.saveStatus = 'error';
                renderApp();
                // Using alert for now for simplicity, but a custom modal is preferred
                setTimeout(() => {
                    alert(t.enterNameCourse);
                    challengesZoneState.saveStatus = ''; // Clear status after a while
                    renderApp();
                }, 100);
                return;
            }

            challengesZoneState.saveStatus = 'saving';
            renderApp();

            const data = {
                name: challengesZoneState.studentName,
                course: challengesZoneState.studentCourse,
                score: challengesZoneState.score,
                totalQuestions: translations[lang].questions.length
            };

            try {
                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    mode: 'cors' // Ensure CORS is handled
                });

                const result = await response.json(); // Parse the JSON response

                if (result.result === 'success') {
                    challengesZoneState.saveStatus = 'saved';
                } else if (result.result === 'evaluation_already_completed') {
                    challengesZoneState.saveStatus = 'evaluation_already_completed';
                    alert(t.evaluationAlreadyCompleted); // Display specific message
                } else if (result.result === 'duplicate_temporary') {
                    challengesZoneState.saveStatus = 'duplicate_temporary';
                    alert(t.duplicateTemporary); // Display specific message
                }
                else {
                    challengesZoneState.saveStatus = 'error';
                    console.error('Error saving to Google Sheets:', result.message);
                    alert(`${t.saveError} ${result.message}`); // Show error message to user
                }
            } catch (error) {
                challengesZoneState.saveStatus = 'error';
                console.error('Network error saving to Google Sheets:', error);
                alert(`${t.saveError} ${error.message}`); // Show network error to user
            } finally {
                renderApp();
                setTimeout(() => {
                    challengesZoneState.saveStatus = ''; // Clear status after a while
                    renderApp();
                }, 5000); // Clear status after 5 seconds
            }
        }


        function ChallengesZone() {
            const t = translations[lang];
            const questions = t.questions;
            const currentQuestion = questions[challengesZoneState.currentQuestionIndex];

            if (!challengesZoneState.isRegistered) {
                return `
                    <div class="p-6 bg-gradient-to-br from-orange-50 to-red-100 min-h-screen">
                        <h2 class="text-4xl font-extrabold text-orange-800 mb-8 text-center">${t.challenges}</h2>
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-xl mx-auto text-center space-y-6">
                            <h3 class="text-3xl font-bold text-gray-800 mb-4">${t.registerForQuiz}</h3>
                            <div class="space-y-4 text-left">
                                <label for="student-name" class="block text-lg font-semibold text-gray-700">${t.studentName}</label>
                                <input type="text" id="student-name"
                                    value="${challengesZoneState.studentName}"
                                    oninput="challengesZoneState.studentName = this.value; renderApp();"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="${t.studentName}" />
                                <label for="student-course" class="block text-lg font-semibold text-gray-700">${t.studentCourse}</label>
                                <input type="text" id="student-course"
                                    value="${challengesZoneState.studentCourse}"
                                    oninput="challengesZoneState.studentCourse = this.value; renderApp();"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="${t.studentCourse}" />
                            </div>
                            <button
                                onclick="startQuizRegistration()"
                                ${(!challengesZoneState.studentName || !challengesZoneState.studentCourse) ? 'disabled' : ''}
                                class="px-8 py-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-xl"
                            >
                                ${t.startButton}
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="p-6 bg-gradient-to-br from-orange-50 to-red-100 min-h-screen">
                    <h2 class="text-4xl font-extrabold text-orange-800 mb-8 text-center">${t.challenges}</h2>

                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-3xl mx-auto text-center space-y-6">
                        <h3 class="text-3xl font-bold text-gray-800 mb-4">${t.challengeTitle}</h3>
                        <p class="text-lg text-gray-600 mb-6">${t.quizIntro}</p>

                        ${challengesZoneState.quizCompleted ? `
                            <div class="space-y-4">
                                <p class="text-2xl font-bold text-indigo-700">${t.finalScore(challengesZoneState.score, questions.length)}</p>
                                <div class="flex flex-col items-center justify-center gap-4 mt-6">
                                    <button
                                        onclick="saveResultsToSheets()"
                                        ${challengesZoneState.saveStatus === 'saving' || challengesZoneState.saveStatus === 'saved' || challengesZoneState.saveStatus === 'evaluation_already_completed' || challengesZoneState.saveStatus === 'duplicate_temporary' ? 'disabled' : ''}
                                        class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        ${challengesZoneState.saveStatus === 'saving' ? t.savingResults : t.saveResults}
                                    </button>
                                    ${challengesZoneState.saveStatus === 'saved' ? `<p class="text-green-600 font-bold">${t.resultsSaved}</p>` : ''}
                                    ${challengesZoneState.saveStatus === 'error' ? `<p class="text-red-600 font-bold">${t.saveError}</p>` : ''}
                                    ${challengesZoneState.saveStatus === 'evaluation_already_completed' ? `<p class="text-red-600 font-bold">${t.evaluationAlreadyCompleted}</p>` : ''}
                                    ${challengesZoneState.saveStatus === 'duplicate_temporary' ? `<p class="text-orange-600 font-bold">${t.duplicateTemporary}</p>` : ''}

                                    <button
                                        onclick="resetQuiz()"
                                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                                    >
                                        ${lang === 'es' ? 'Reiniciar Cuestionario' : 'Restart Quiz'}
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                <p class="text-xl font-semibold text-gray-800">
                                    ${challengesZoneState.currentQuestionIndex + 1}. ${currentQuestion.question}
                                </p>

                                <div class="grid grid-cols-1 gap-4">
                                    ${currentQuestion.options.map((option, index) => `
                                        <button
                                            onclick="setSelectedOptionInChallenges('${option}')"
                                            class="
                                                py-3 px-5 rounded-lg border-2 text-lg text-gray-700
                                                ${challengesZoneState.selectedOption === option ? 'bg-indigo-100 border-indigo-500' : 'bg-gray-50 border-gray-200'}
                                                hover:bg-indigo-50 hover:border-indigo-400 transition duration-200 ease-in-out
                                                flex items-center justify-between
                                                ${challengesZoneState.feedback !== null ? 'opacity-70 cursor-not-allowed' : ''}
                                            "
                                            ${challengesZoneState.feedback !== null ? 'disabled' : ''}
                                        >
                                            ${option}
                                            ${challengesZoneState.selectedOption === option && challengesZoneState.feedback === 'correct' ? `${getLucideIcon('Check', 20, 'text-green-500')}` : ''}
                                            ${challengesZoneState.selectedOption === option && challengesZoneState.feedback === 'incorrect' ? `${getLucideIcon('X', 20, 'text-red-500')}` : ''}
                                        </button>
                                    `).join('')}
                                </div>

                                ${challengesZoneState.feedback ? `
                                    <p class="text-xl font-bold ${challengesZoneState.feedback === 'correct' ? 'text-green-600' : 'text-red-600'}">
                                        ${challengesZoneState.feedback === 'correct' ? t.correct : `${t.incorrect} ${currentQuestion.answer}`}
                                    </p>
                                ` : ''}

                                <div class="flex justify-center gap-4 mt-8">
                                    ${!challengesZoneState.feedback ? `
                                        <button
                                            onclick="handleSubmitQuiz()"
                                            ${challengesZoneState.selectedOption === null ? 'disabled' : ''}
                                            class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            ${t.submitAnswer}
                                        </button>
                                    ` : `
                                        <button
                                            onclick="handleNextQuestionInChallenges()"
                                            class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105"
                                        >
                                            ${t.nextQuestion}
                                        </button>
                                    `}
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // --- Global state management and rendering ---

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            let content = '';

            // Stop simulation when leaving Virtual Lab
            if (currentPage !== 'virtualLab') {
                stopSimulation();
            } else {
                startSimulation();
            }

            switch (currentPage) {
                case 'home':
                    content = Home();
                    break;
                case 'virtualLab':
                    content = VirtualLab();
                    break;
                case 'theoryZone':
                    content = TheoryZone();
                    break;
                case 'challenges':
                    content = ChallengesZone();
                    break;
                default:
                    content = Home();
            }

            appRoot.innerHTML = Navbar() + `<main>${content}</main>`;

            // Trigger Lucide icons rendering after HTML is inserted
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }

            // Trigger MathJax rendering after HTML is inserted
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        function setCurrentPageAndRender(page) {
            currentPage = page;
            renderApp();
        }

        function setLanguage(newLang) {
            lang = newLang;
            renderApp();
        }

        // Functions for VirtualLab interaction (these now just update state and trigger a full render)
        function handleVolumeChangeInVirtualLab(value) {
            virtualLabState.volume = value;
            virtualLabState.containerHeight = value * 3; // Update container height based on volume
            // Logic for Boyle's and Charles's laws applied to pressure/temperature here
            if (virtualLabState.selectedLaw === 'boyle') {
                const initialPressure = virtualLabState.pvData.length > 0 ? virtualLabState.pvData[0].p : 1;
                const initialVolume = virtualLabState.pvData.length > 0 ? virtualLabState.pvData[0].v : 50;
                if (value !== 0) { // Avoid division by zero
                    virtualLabState.pressure = (initialPressure * initialVolume) / value;
                }
            } else if (virtualLabState.selectedLaw === 'charles' && virtualLabState.pressure > 0) {
                const initialVolume = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].v : 50;
                const initialTemp = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].t : 273.15;
                if (initialVolume !== 0) { // Avoid division by zero
                    virtualLabState.temperature = (initialTemp * value) / initialVolume;
                }
            }
            renderApp();
        }

        function handleTemperatureChangeInVirtualLab(value) {
            virtualLabState.temperature = value;
            // Logic for Gay-Lussac's and Charles's laws applied to pressure/volume here
            if (virtualLabState.selectedLaw === 'gayLussac' && virtualLabState.temperature > 0) {
                const initialPressure = virtualLabState.ptData.length > 0 ? virtualLabState.ptData[0].p : 1;
                const initialTemp = virtualLabState.ptData.length > 0 ? virtualLabState.ptData[0].t : 273.15;
                if (initialTemp !== 0) { // Avoid division by zero
                    virtualLabState.pressure = (initialPressure * value) / initialTemp;
                }
            } else if (virtualLabState.selectedLaw === 'charles' && virtualLabState.temperature > 0) {
                const initialVolume = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].v : 50;
                const initialTemp = virtualLabState.vtData.length > 0 ? virtualLabState.vtData[0].t : 273.15;
                if (initialTemp !== 0) { // Avoid division by zero
                    virtualLabState.volume = (initialVolume * value) / initialTemp;
                    virtualLabState.containerHeight = (virtualLabState.volume * 3);
                }
            }
            renderApp();
        }

        function handleLawSelectChangeInVirtualLab(newLaw) {
            virtualLabState.selectedLaw = newLaw;
            virtualLabState.pvData = [];
            virtualLabState.vtData = [];
            virtualLabState.ptData = [];
            initParticles();
            renderApp();
        }

        // Functions for TheoryZone interaction
        function handleLawSelectChangeInTheoryZone(newLaw) {
            theoryZoneState.selectedLaw = newLaw;
            renderApp();
        }

        // Functions for ChallengesZone interaction
        function startQuizRegistration() {
            if (challengesZoneState.studentName && challengesZoneState.studentCourse) {
                challengesZoneState.isRegistered = true;
                challengesZoneState.currentQuestionIndex = 0; // Reset quiz when starting
                challengesZoneState.score = 0;
                challengesZoneState.quizCompleted = false;
                challengesZoneState.selectedOption = null;
                challengesZoneState.feedback = null;
                challengesZoneState.saveStatus = '';
                renderApp();
            } else {
                alert(translations[lang].enterNameCourse);
            }
        }

        function setSelectedOptionInChallenges(option) {
            challengesZoneState.selectedOption = option;
            renderApp();
        }

        function handleSubmitQuiz() {
            const currentQuestion = translations[lang].questions[challengesZoneState.currentQuestionIndex];
            if (challengesZoneState.selectedOption === currentQuestion.answer) {
                challengesZoneState.feedback = 'correct';
                challengesZoneState.score += 1;
            } else {
                challengesZoneState.feedback = 'incorrect';
            }
            renderApp();
        }

        function handleNextQuestionInChallenges() {
            challengesZoneState.selectedOption = null;
            challengesZoneState.feedback = null;
            if (challengesZoneState.currentQuestionIndex < translations[lang].questions.length - 1) {
                challengesZoneState.currentQuestionIndex += 1;
            } else {
                challengesZoneState.quizCompleted = true;
            }
            renderApp();
        }

        function resetQuiz() {
            challengesZoneState.currentQuestionIndex = 0;
            challengesZoneState.selectedOption = null;
            challengesZoneState.feedback = null;
            challengesZoneState.score = 0;
            challengesZoneState.quizCompleted = false;
            challengesZoneState.isRegistered = false; // Reset registration
            challengesZoneState.studentName = '';
            challengesZoneState.studentCourse = '';
            challengesZoneState.saveStatus = '';
            renderApp();
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
            // startSimulation() is now called within renderApp() when currentPage === 'virtualLab'
        });
    </script>
</body>
</html>
